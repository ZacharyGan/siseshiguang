<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>å››è‰²æ‹¾å…‰</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<style>
/* === é¢œè‰²å˜é‡ === */
:root{--è¯­æ–‡:#e74c3c;--ç†ç§‘:#3498db;--è‹±è¯­:#27ae60;--äº¤æµ:#ffffff;--card-bg:#fff;--left-bubble:#fff;--right-bubble:#95ec69;--like:#f44336;}

/* === åŸºç¡€æ ·å¼ï¼ˆåŒå‰ï¼‰ === */
*{box-sizing:border-box;margin:0;padding:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif;}
body{background:#ededed;line-height:1.6}
header{background:#222;color:#fff;padding:1rem;text-align:center;position:relative}
header h1{font-size:1.8rem;letter-spacing:2px}
nav{display:flex;flex-wrap:wrap;justify-content:center;background:#222}
nav button{flex:1 1 120px;border:none;padding:1rem;font-size:1rem;cursor:pointer;transition:.3s;color:#fff}
nav button.è¯­æ–‡{background:var(--è¯­æ–‡)}nav button.ç†ç§‘{background:var(--ç†ç§‘)}nav button.è‹±è¯­{background:var(--è‹±è¯­)}nav button.äº¤æµ{background:var(--äº¤æµ);color:#222}
nav button.active{opacity:.7}
main{padding:1rem;max-width:900px;margin:auto;min-height:calc(100vh - 220px);display:flex;flex-direction:column}
.section{display:none;flex-direction:column;height:100%}.section.active{display:flex}
.sec-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:1rem}
.sec-title{font-size:1.5rem;font-weight:bold}
.upload-btn{background:var(--è‹±è¯­);color:#fff;border:none;padding:.5rem 1rem;border-radius:4px;cursor:pointer}
.grid{display:flex;flex-wrap:wrap;gap:1rem}
.square-card{width:180px;height:180px;background:var(--card-bg);border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,.1);display:flex;flex-direction:column;justify-content:center;align-items:center;text-align:center;padding:.8rem;cursor:pointer;transition:transform .2s}
.square-card:hover{transform:translateY(-4px)}
.card-title{font-size:1.1rem;font-weight:bold;margin-bottom:.4rem;word-break:break-all}
.card-meta{font-size:.8rem;color:#666;margin-bottom:.4rem}
/* ç‚¹èµåŒº */
.like-bar{display:flex;align-items:center;gap:.3rem;font-size:.8rem;color:#555}
.like-btn{cursor:pointer;background:none;border:none;font-size:1rem;color:#666}
.like-btn.liked{color:var(--like)}
.card-detail{display:none;margin-top:.8rem;text-align:left;width:100%}
.card-detail .detail-title{font-size:1.3rem;font-weight:bold;margin-bottom:.6rem}
.card-detail .detail-md{line-height:1.7}
.modal-mask{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;justify-content:center;align-items:center;z-index:999}
.modal{background:#fff;width:90%;max-width:520px;border-radius:8px;padding:1.2rem;display:flex;flex-direction:column;gap:.8rem}
#regPage{position:fixed;inset:0;background:#fff;z-index:1000;display:flex;flex-direction:column;align-items:center;padding:2rem 1rem}
#regPage h2{margin-bottom:1rem}
#regForm{width:100%;max-width:400px;display:flex;flex-direction:column;gap:.6rem}
.avatarBox{display:flex;align-items:center;gap:1rem}
.avatarBox img{width:80px;height:80px;border-radius:50%;object-fit:cover;background:#eee}
input[type=text],input[type=date],select{width:100%;padding:.6rem;margin-bottom:.6rem;border:1px solid #ddd;border-radius:4px}
button.publish{background:#222;color:#fff;padding:.7rem 1.2rem;border:none;border-radius:4px;cursor:pointer}
button.publish:hover{background:#444}
</style>
</head>
<body>

<!-- ======== æ³¨å†Œé¡µ ======== -->
<div id="regPage">
  <h2>æ¬¢è¿ç¬¬ä¸€æ¬¡æ¥åˆ°ã€Œå››è‰²æ‹¾å…‰ã€</h2>
  <form id="regForm" onsubmit="return doReg()">
    <input id="regUser" placeholder="ç”¨æˆ·åï¼ˆå¿…å¡«ï¼Œä¸å¯é‡å¤ï¼‰" required>
    <select id="regGender" required><option value="">è¯·é€‰æ‹©æ€§åˆ«</option><option>ç”·</option><option>å¥³</option><option>ä¿å¯†</option></select>
    <input id="regBirth" type="date">
    <input id="regSchool" placeholder="å­¦æ ¡ï¼ˆé€‰å¡«ï¼‰">
    <input id="regGrade" placeholder="å¹´çº§ç­çº§ï¼ˆé€‰å¡«ï¼‰">
    <div class="avatarBox"><img id="avatarPreview" src=""><div><input type="file" id="avatarFile" accept="image/*" onchange="previewAvatar()"><div style="font-size:.8rem;color:#666">ç‚¹å‡»é€‰æ‹©å¤´åƒï¼ˆé€‰å¡«ï¼‰</div></div></div>
    <button type="submit" class="publish">è¿›å…¥ç½‘ç«™</button>
  </form>
</div>

<!-- ======== ä¸»ç«™ ======== -->
<header id="mainHeader" style="display:none"><h1>å››è‰²æ‹¾å…‰</h1><p>æŠŠæˆ‘ä»¬çš„ä½œæ–‡ä¸æ€è€ƒï¼Œåˆ†é—¨åˆ«ç±»åœ°æ”¶é›†èµ·æ¥</p>
  <div style="position:absolute;right:1rem;top:1rem;display:flex;align-items:center;gap:.5rem;color:#fff;font-size:0.9rem"><img id="topAvatar" width="32" height="32" style="border-radius:50%;object-fit:cover;background:#eee"><span id="topUser"></span></div>
</header>
<nav id="mainNav" style="display:none">
  <button class="è¯­æ–‡" onclick="switchSec('è¯­æ–‡')">è¯­æ–‡ä½œæ–‡</button><button class="ç†ç§‘ active" onclick="switchSec('ç†ç§‘')">ç†ç§‘è§£ç­”</button><button class="è‹±è¯­" onclick="switchSec('è‹±è¯­')">è‹±è¯­ä½œæ–‡</button><button class="äº¤æµ" onclick="switchSec('äº¤æµ')">è®¨è®ºäº¤æµ</button>
</nav>
<main id="mainMain" style="display:none">
  <!-- ç†ç§‘ --><div class="section active" id="ç†ç§‘"><div class="sec-header"><div class="sec-title" style="color:var(--ç†ç§‘)">ç†ç§‘æ¿å—</div><button class="upload-btn" onclick="openUpload('ç†ç§‘')">+ ä¸Šä¼ é¢˜è§£</button></div><div class="grid" id="ç†ç§‘-grid"></div></div>
  <!-- è¯­æ–‡ --><div class="section" id="è¯­æ–‡"><div class="sec-header"><div class="sec-title" style="color:var(--è¯­æ–‡)">è¯­æ–‡æ¿å—</div><button class="upload-btn" onclick="openUpload('è¯­æ–‡')">+ ä¸Šä¼ æ–°ä½œæ–‡</button></div><div class="grid" id="è¯­æ–‡-grid"></div></div>
  <!-- è‹±è¯­ --><div class="section" id="è‹±è¯­"><div class="sec-header"><div class="sec-title" style="color:var(--è‹±è¯­)">è‹±è¯­æ¿å—</div><button class="upload-btn" onclick="openUpload('è‹±è¯­')">+ ä¸Šä¼ æ–°ä½œæ–‡</button></div><div class="grid" id="è‹±è¯­-grid"></div></div>
  <!-- äº¤æµ --><div class="section" id="äº¤æµ"><div class="chatHeader"><div id="chatTitle">å¤§ç¾¤</div><select id="userSelect" onchange="changeChat()"><option value="">â€” é€‰æ‹©ç”¨æˆ·ç§èŠ â€”</option></select></div><div id="messages" class="messages"></div><div class="inputArea"><textarea id="msgInput" placeholder="è¾“å…¥æ¶ˆæ¯â€¦" onkeydown="if(event.key==='Enter'&&!event.shiftKey){sendMsg();event.preventDefault()}"></textarea><button onclick="sendMsg()">å‘é€</button></div></div>
</main>

<!-- ä¸Šä¼ å¼¹çª— --><div id="uploadMask" class="modal-mask"><div class="modal"><h3 id="modalTitle"></h3><input id="titleInput" placeholder="è¯·è¾“å…¥é¢˜ç›®"><textarea id="mdInput" placeholder="è¯·è¾“å…¥æ­£æ–‡ï¼ˆæ”¯æŒ Markdownï¼‰"></textarea><div style="text-align:right"><button onclick="saveUpload()">ä¿å­˜</button><button onclick="closeUpload()">å–æ¶ˆ</button></div></div></div>

<script>
/* ========== ç”¨æˆ·ç³»ç»Ÿ ========== */
const LS_USER = 'sise_userName', LS_UINFO = 'sise_userInfo';
let userName = localStorage.getItem(LS_USER), userInfo = JSON.parse(localStorage.getItem(LS_UINFO) || '{}');
if (!userName || !userInfo.user) showReg(); else showMain();

function showReg() {
    document.getElementById('regPage').style.display = 'flex';
    document.getElementById('mainHeader').style.display = 'none';
    document.getElementById('mainNav').style.display = 'none';
    document.getElementById('mainMain').style.display = 'none';
}
function showMain() {
    document.getElementById('regPage').style.display = 'none';
    document.getElementById('mainHeader').style.display = 'block';
    document.getElementById('mainNav').style.display = 'flex';
    document.getElementById('mainMain').style.display = 'block';
    document.getElementById('topUser').textContent = userInfo.user;
    document.getElementById('topAvatar').src = userInfo.avatar || '';
    renderGrid('ç†ç§‘'); renderGridOld('è¯­æ–‡'); renderGridOld('è‹±è¯­'); renderMessages();
}
function previewAvatar() {
    const file = document.getElementById('avatarFile').files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = e => document.getElementById('avatarPreview').src = e.target.result;
    reader.readAsDataURL(file);
}
function doReg() {
    const name = document.getElementById('regUser').value.trim();
    if (!name) return alert('ç”¨æˆ·åä¸èƒ½ä¸ºç©º');
    for (let i = 0; i < localStorage.length; i++) {
        const k = localStorage.key(i);
        if (k.startsWith('u_') && k.slice(2) === name) return alert('ç”¨æˆ·åå·²å­˜åœ¨ï¼');
    }
    const file = document.getElementById('avatarFile').files[0];
    const info = {
        user: name,
        gender: document.getElementById('regGender').value,
        birth: document.getElementById('regBirth').value,
        school: document.getElementById('regSchool').value,
        grade: document.getElementById('regGrade').value,
        avatar: file ? document.getElementById('avatarPreview').src : ''
    };
    localStorage.setItem(LS_USER, name);
    localStorage.setItem(LS_UINFO, JSON.stringify(info));
    localStorage.setItem('u_' + name, '1');
    userName = name; userInfo = info;
    showMain();
    return false;
}

/* ========== æ¿å—åˆ‡æ¢ ========== */
const sections = ['è¯­æ–‡', 'ç†ç§‘', 'è‹±è¯­', 'äº¤æµ'];
function switchSec(sec) {
    sections.forEach(s => {
        document.getElementById(s).classList.remove('active');
        document.querySelector(`nav button.${s}`).classList.remove('active');
    });
    document.getElementById(sec).classList.add('active');
    document.querySelector(`nav button.${sec}`).classList.add('active');
    if (sec === 'äº¤æµ') { initUserSelect(); changeChat(); }
    else if (sec === 'ç†ç§‘') renderGrid(sec);
    else if (sec === 'è¯­æ–‡' || sec === 'è‹±è¯­') renderGridOld(sec);
}

/* ========== èŠå¤© ========== */
let currentTo = '';
function initUserSelect() {
    const sel = document.getElementById('userSelect');
    sel.innerHTML = '<option value="">â€” é€‰æ‹©ç”¨æˆ·ç§èŠ â€”</option>';
    for (let i = 0; i < localStorage.length; i++) {
        const k = localStorage.key(i);
        if (k.startsWith('u_')) {
            const name = k.slice(2);
            if (name === userName) continue;
            const opt = document.createElement('option');
            opt.value = name; opt.textContent = name; sel.appendChild(opt);
        }
    }
}
function changeChat() {
    currentTo = document.getElementById('userSelect').value;
    document.getElementById('chatTitle').textContent = currentTo || 'å¤§ç¾¤';
    renderMessages();
}
function renderMessages() {
    const box = document.getElementById('messages');
    box.innerHTML = '';
    const arr = JSON.parse(localStorage.getItem(currentTo ? `ç§èŠ_${currentTo}` : 'å¤§ç¾¤') || '[]');
    arr.forEach(m => {
        const isMe = m.from === userName;
        const div = document.createElement('div');
        div.className = 'msg ' + (isMe ? 'me' : 'other');
        div.innerHTML = `<img src="${m.avatar || ''}" onerror="this.src=''"><div><div class="bubble">${m.txt}</div><div class="time">${m.time}ã€€<b>${isMe ? 'æˆ‘' : m.from}</b></div></div>`;
        box.appendChild(div);
    });
    box.scrollTop = box.scrollHeight;
}
function sendMsg() {
    const txt = document.getElementById('msgInput').value.trim();
    if (!txt) return;
    const key = currentTo ? `ç§èŠ_${currentTo}` : 'å¤§ç¾¤';
    const arr = JSON.parse(localStorage.getItem(key) || '[]');
    arr.push({ from: userName, to: currentTo, txt, time: new Date().toLocaleString(), avatar: userInfo.avatar || '' });
    localStorage.setItem(key, JSON.stringify(arr));
    document.getElementById('msgInput').value = '';
    renderMessages();
}

/* ========== ç‚¹èµç›¸å…³ ========== */
function toggleLike(cardDiv, item, sec, idx) {
    if (!item.likes) item.likes = [];
    const i = item.likes.indexOf(userName);
    if (i === -1) item.likes.push(userName); else item.likes.splice(i, 1);
    // å†™å› localStorage
    const arr = JSON.parse(localStorage.getItem('å››è‰²æ‹¾å…‰_' + sec) || '[]');
    arr[idx] = item;
    localStorage.setItem('å››è‰²æ‹¾å…‰_' + sec, JSON.stringify(arr));
    // åˆ·æ–°å½“å‰æ¿å—
    sec === 'ç†ç§‘' ? renderGrid(sec) : renderGridOld(sec);
}

/* ========== æ¸²æŸ“å‡½æ•°ï¼ˆå«ç‚¹èµï¼‰ ========== */
function renderGrid(sec) {
    const grid = document.getElementById(sec + '-grid');
    grid.innerHTML = '';
    const arr = JSON.parse(localStorage.getItem('å››è‰²æ‹¾å…‰_' + sec) || '[]');
    arr.reverse().forEach((item, idx) => {
        if (!item.likes) item.likes = [];
        const card = document.createElement('div');
        card.className = 'square-card';
        const detail = document.createElement('div');
        detail.className = 'card-detail';
        detail.innerHTML = `<div class="detail-title">${item.title}</div><div class="detail-md">${marked.parse(item.md)}</div>`;

        // ç‚¹èµæ 
        const likeBar = document.createElement('div');
        likeBar.className = 'like-bar';
        const liked = item.likes.indexOf(userName) !== -1;
        likeBar.innerHTML = `
            <button class="like-btn ${liked ? 'liked' : ''}" onclick="toggleLike(this.parentElement.parentElement, ${JSON.stringify(item).replace(/"/g,'&quot;')}, '${sec}', ${arr.length - 1 - idx})">${liked ? 'â¤' : 'ğŸ¤'}</button>
            <span>${item.likes.length} èµ</span>
        `;

        card.innerHTML = `<div class="card-title">${item.title}</div><div class="card-meta">${item.user} Â· ${item.time}</div>`;
        card.appendChild(likeBar);
        card.appendChild(detail);
        card.onclick = e => { if (e.target.closest('.like-bar')) return; detail.style.display = detail.style.display === 'block' ? 'none' : 'block'; };
        grid.appendChild(card);
    });
}
function renderGridOld(sec) {
    const grid = document.getElementById(sec + '-grid');
    grid.innerHTML = '';
    const arr = JSON.parse(localStorage.getItem('å››è‰²æ‹¾å…‰_' + sec) || '[]');
    arr.reverse().forEach((item, idx) => {
        if (!item.likes) item.likes = [];
        const card = document.createElement('div');
        card.className = 'square-card';
        const cont = document.createElement('div');
        cont.className = 'card-detail';
        cont.innerHTML = (item.txt || '').replace(/\n/g, '<br>');

        // ç‚¹èµæ 
        const likeBar = document.createElement('div');
        likeBar.className = 'like-bar';
        const liked = item.likes.indexOf(userName) !== -1;
        likeBar.innerHTML = `
            <button class="like-btn ${liked ? 'liked' : ''}" onclick="toggleLike(this.parentElement.parentElement, ${JSON.stringify(item).replace(/"/g,'&quot;')}, '${sec}', ${arr.length - 1 - idx})">${liked ? 'â¤' : 'ğŸ¤'}</button>
            <span>${item.likes.length} èµ</span>
        `;

        card.innerHTML = `<div class="card-title">${item.title || 'æ— é¢˜'}</div><div class="card-meta">${item.user} Â· ${item.time}</div>`;
        card.appendChild(likeBar);
        card.appendChild(cont);
        card.onclick = e => { if (e.target.closest('.like-bar')) return; cont.style.display = cont.style.display === 'block' ? 'none' : 'block'; };
        grid.appendChild(card);
    });
}

/* ========== ä¸Šä¼ å¼¹çª— ========== */
let uploadSec = '';
function openUpload(sec) {
    uploadSec = sec;
    document.getElementById('modalTitle').textContent = sec === 'ç†ç§‘' ? 'ä¸Šä¼ é¢˜è§£' : 'ä¸Šä¼ ä½œæ–‡';
    document.getElementById('uploadMask').style.display = 'flex';
    document.getElementById('titleInput').value = '';
    document.getElementById('mdInput').value = '';
}
function closeUpload() {
    document.getElementById('uploadMask').style.display = 'none';
}
function saveUpload() {
    const title = document.getElementById('titleInput').value.trim();
    const md = document.getElementById('mdInput').value.trim();
    if (!title || !md) return alert('é¢˜ç›®å’Œæ­£æ–‡éƒ½è¦å¡«å†™ï¼');
    const key = 'å››è‰²æ‹¾å…‰_' + uploadSec;
    const arr = JSON.parse(localStorage.getItem(key) || '[]');
    const payload = uploadSec === 'ç†ç§‘'
        ? { title, md, user: userName, time: new Date().toLocaleString(), likes: [] }
        : { title, txt: md, user: userName, time: new Date().toLocaleString(), likes: [] };
    arr.push(payload);
    localStorage.setItem(key, JSON.stringify(arr));
    closeUpload();
    uploadSec === 'ç†ç§‘' ? renderGrid(uploadSec) : renderGridOld(uploadSec);
}
</script>
</body>
</html>